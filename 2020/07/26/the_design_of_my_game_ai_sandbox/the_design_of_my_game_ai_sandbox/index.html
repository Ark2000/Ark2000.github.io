<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>【Godot Engine】游戏AI沙箱的设计 | k2kra&#39;s shelter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言游戏AI一直都是我很感兴趣的话题，借着学习各种AI技术的机会，我打算在这篇文章里记录一下我所设计的一个AI沙箱。如果要设计AI的话，首先要有一个能让你的AI代码跑起来的环境，这个环境在我看来就是AI沙箱。">
<meta property="og:type" content="article">
<meta property="og:title" content="【Godot Engine】游戏AI沙箱的设计">
<meta property="og:url" content="http://ark2000.github.io/2020/07/26/the_design_of_my_game_ai_sandbox/the_design_of_my_game_ai_sandbox/index.html">
<meta property="og:site_name" content="k2kra&#39;s shelter">
<meta property="og:description" content="前言游戏AI一直都是我很感兴趣的话题，借着学习各种AI技术的机会，我打算在这篇文章里记录一下我所设计的一个AI沙箱。如果要设计AI的话，首先要有一个能让你的AI代码跑起来的环境，这个环境在我看来就是AI沙箱。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/26/aCtxN8.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/26/aCyPiR.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/26/aC6y9I.png">
<meta property="article:published_time" content="2020-07-26T13:27:00.000Z">
<meta property="article:modified_time" content="2020-07-28T04:42:51.970Z">
<meta property="article:author" content="k2kra">
<meta property="article:tag" content="GameDevelopment">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/07/26/aCtxN8.png">
  
    <link rel="alternate" href="/atom.xml" title="k2kra&#39;s shelter" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">k2kra&#39;s shelter</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">How much are you willing to pay for your dream？</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://ark2000.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-the_design_of_my_game_ai_sandbox/the_design_of_my_game_ai_sandbox" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/26/the_design_of_my_game_ai_sandbox/the_design_of_my_game_ai_sandbox/" class="article-date">
  <time datetime="2020-07-26T13:27:00.000Z" itemprop="datePublished">2020-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      【Godot Engine】游戏AI沙箱的设计
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>游戏AI一直都是我很感兴趣的话题，借着学习各种AI技术的机会，我打算在这篇文章里记录一下我所设计的一个AI沙箱。如果要设计AI的话，首先要有一个能让你的AI代码跑起来的环境，这个环境在我看来就是AI沙箱。</p>
<a id="more"></a>

<p>我所使用的开发环境是Godot Engine(V3.2.2)，一个拥有着活跃社区的开源游戏引擎。因为我也是属于刚入门的业余爱好者，所以不是很专业，很多概念是我自己创造出来的，设计也可能会比较粗糙甚至存在问题，不过这会在以后改进。</p>
<h1 id="沙箱环境"><a href="#沙箱环境" class="headerlink" title="沙箱环境"></a>沙箱环境</h1><p>AI沙箱，我首先想到的是要有一个自由活动的环境（以下简称Env），Env我采用的方案是tilemap（如图，整个环境由规整的方格组成），主要目的是为了降低寻路方面的编程负担。Env具有大小限制(使用红色方框标记)，暂时只有两种基本地形，一种是空，另一种是，NPC无法通过墙壁。</p>
<p><img src="https://s1.ax1x.com/2020/07/26/aCtxN8.png" alt="tilemap"></p>
<p>除了储存基本的地图数据，Env还负责提供寻路的API <code>calculate_path</code>，以供NPC调用（理想情况是NPC自己探索环境，然后根据已知计算路径，而不是一开始就处于全知状态，不过这样做会增加系统复杂度，以后会考虑）。</p>
<p>计算路径的API接受起点和终点输入，输出最短的路径，不存在路径的话返回空集。在算法方面，使用的是Astar算法，该算法由Godot提供，规模在20X以内的地图计算速度非常快，可以忽略时间，但不清楚在大型地图下的表现。如果以后出现性能问题的话，可能需要自己手动添加多线程的支持，以防止阻碍游戏主线程的运行。</p>
<p>使用Godot提供的AStar算法的方式很简单，在Env初始化时，使用<code>add_point</code>（添加顶点）和<code>connect_points</code>（连接顶点）将tilemap数据转换为AStar内部的图结构即可。寻路算法使用自己专属的数据，优势非常明显，以后可以很方便的调整动态变化的障碍物(比如放置实体和移除实体)。</p>
<p>使用Godot Astar算法还有一点细节就是，在该算法的数据结构中，使用ID作为每一个点的唯一标识，而2D位置是作为点的属性存在的，这意味着你不能够通过点的位置直接访问点。需要额外的提供将ID和坐标相互转换的函数。实现非常简单，ID从0自然增长，坐标从左到右，从上到下逐个映射到ID即可。</p>
<p>Env的设计到这里就简单的结束了。</p>
<h1 id="实体管理"><a href="#实体管理" class="headerlink" title="实体管理"></a>实体管理</h1><p>实体是一个很宽泛的概念，就我目前的理解而言，出现以下特征之一的就可以算作是实体。</p>
<ul>
<li>需要逐帧更新</li>
<li>需要访问其他实体</li>
<li>存在一定的生命周期</li>
<li>具有位置属性</li>
</ul>
<p>在这个简单的沙箱中，我设计了三种实体</p>
<ul>
<li>NPC，最为复杂的实体，也只之后要谈论的主题</li>
<li>可拾取的地面道具（金币，食物）</li>
<li>售货机，NPC在此处可以使用金币购买，售货机会生成并弹出道具</li>
</ul>
<p>要管理这些实体，让它们之间相互感知，就需要一个实体管理器（<code>EntityManager</code>）。该单例对象存储所有实体的引用（同时每一个实体也都有该实体管理器的引用），实体管理器负责统一调用所有实体的更新方法，提供查找实体的api（比如返回距离某个位置最近的一个金币，返回某个位置上的所有实体），管理实体的生命周期，等等。</p>
<h1 id="NPC设计"><a href="#NPC设计" class="headerlink" title="NPC设计"></a>NPC设计</h1><p>NPC设计的方向是，NPC和AI完全分离，NPC可以搭载不同的AI，以表现出不同的行为模式，因此，NPC内部如何处理来自AI的指令就显得很重要。</p>
<p>下面是一段简单的AI脚本，NPC将在两点之间来回无限移动。我将解释NPC是如何执行这段脚本的。</p>
<p><img src="https://s1.ax1x.com/2020/07/26/aCyPiR.png" alt="AI脚本"></p>
<p><img src="https://s1.ax1x.com/2020/07/26/aC6y9I.png" alt="行为"></p>
<p>当AI脚本中执行一条NPC指令时，NPC不会立即执行该指令，而是将该指令添加到它的指令队列中去，然后逐条解释指令执行。</p>
<p>比如<code>npc.q_move_to(Vector2(3, 4))</code>, 调用之后，NPC内部的指令队列就多了一条<code>move_to(3, 4)</code>。</p>
<p><code>test2()</code>函数执行完后，NPC的指令队列如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">move_to(3, 4)</span><br><span class="line">wait(1.0)</span><br><span class="line">move_to(7, 8)</span><br><span class="line">say_sth(&quot;ok&quot;, 0.4)</span><br><span class="line">callback(AI对象, &quot;test2&quot;)</span><br></pre></td></tr></table></figure>

<p>AI脚本中一旦调用NPC的API，接下来NPC就回去自动开始执行指令队列中的内容。</p>
<p>比如NPC取出第一条指令执行时，会将移动操作展开成若干的上下左右移动基本操作。第一条指令执行完成后，NPC的指令队列如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">move_up</span><br><span class="line">move_right</span><br><span class="line">move_right</span><br><span class="line">wait(1.0)</span><br><span class="line">move_to(7, 8)</span><br><span class="line">say_sth(&quot;ok&quot;, 0.4)</span><br><span class="line">callback(AI对象, &quot;test2&quot;)</span><br></pre></td></tr></table></figure>

<p>一旦一条指令执行完毕，NPC就会自动取出队列中的下一条指令继续执行，直到队列为空为止。在这里，NPC会继续执行<code>move_up</code>指令。</p>
<p>最后要提的便是<code>callback</code>指令，NPC执行到<code>callback</code>指令时，会去调用AI脚本中指定的函数。这样，可以使AI脚本感知到指令之间的间隙，执行一些诸如循环，判断之类的操作。在这里，我使用<code>callback</code>指令实现循环。执行<code>callback</code>指令前后NPC的指令队列如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#执行前</span><br><span class="line">callback(AI对象, &quot;test2&quot;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#执行后</span><br><span class="line">move_to(3, 4)</span><br><span class="line">wait(1.0)</span><br><span class="line">move_to(7, 8)</span><br><span class="line">say_sth(&quot;ok&quot;, 0.4)</span><br><span class="line">callback(AI对象, &quot;test2&quot;)</span><br></pre></td></tr></table></figure>

<h1 id="DEMO展示"><a href="#DEMO展示" class="headerlink" title="DEMO展示"></a>DEMO展示</h1><p><a href="https://www.bilibili.com/video/BV1j5411e7rS/" target="_blank" rel="noopener">视频链接</a></p>
<p>在这个DEMO中, NPC会在沙箱中闲逛，当饥饿时，会去寻找沙箱中生成的金币，进而到售货机处购买食物进食，应用了一个简单的状态机模型。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://ark2000.github.io/2020/07/26/the_design_of_my_game_ai_sandbox/the_design_of_my_game_ai_sandbox/" data-id="ckd5gffo00000y0uoez6vfyij" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GameDevelopment/" rel="tag">GameDevelopment</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/06/30/designpattern_report/report/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">设计模式 实验报告</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/GameDevelopment/" rel="tag">GameDevelopment</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Others/" rel="tag">Others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SchoolWorks/" rel="tag">SchoolWorks</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/GameDevelopment/" style="font-size: 20px;">GameDevelopment</a> <a href="/tags/Others/" style="font-size: 10px;">Others</a> <a href="/tags/SchoolWorks/" style="font-size: 15px;">SchoolWorks</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/26/the_design_of_my_game_ai_sandbox/the_design_of_my_game_ai_sandbox/">【Godot Engine】游戏AI沙箱的设计</a>
          </li>
        
          <li>
            <a href="/2020/06/30/designpattern_report/report/">设计模式 实验报告</a>
          </li>
        
          <li>
            <a href="/2020/04/01/start_from_scratch_to_make_my_roguelike/start_from_scratch_to_make_my_roguelike/">Start From Scratch to Make My Roguelike</a>
          </li>
        
          <li>
            <a href="/2020/03/08/how_to_start_my_game_development/how_to_start_my_game_developement/">How to Begin Your Game Development?</a>
          </li>
        
          <li>
            <a href="/2019/12/14/discretemath_report/discretemath_report/">离散数学 实验报告</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 k2kra<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>